<!DOCTYPE HTML>
<html>
  <head>
    <meta http-equiv="content-type" content="text/html; charset=utf-8" />
    <meta name="viewport" content="width=device-width">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="application-name" content="OpenLayers Demo">
    <link rel="shortcut icon" sizes="196x196" href="icon.png"> 
    <title>OpenLayers Demo</title>
	<script src="http://people.rit.edu/yxs9493/api/jquery-1.11.0.min.js"></script>
    <script src="http://www.ist.rit.edu/~jxs/classes/2014_Spring/Mobile/OpenLayers-2.13.1/OpenLayers.js" type="text/javascript"></script>
    <script src="https://maps.googleapis.com/maps/api/js?v=3.exp&sensor=false"></script>
    <script type="text/javascript">
		var openStreet = new Object();
		openStreet.map = null;
    
      function init() {
        openStreet.map                = new OpenLayers.Map( "basicMap" );
        var mapnik         = new OpenLayers.Layer.OSM();
        var fromProjection = new OpenLayers.Projection( "EPSG:4326" );   // Transform from WGS 1984
        var toProjection   = new OpenLayers.Projection( "EPSG:900913" ); // to Spherical Mercator Projection
        var position       = new OpenLayers.LonLat( -77.68,43.08 ).transform( fromProjection, toProjection );
        /* var position       = new OpenLayers.LonLat( 13.41,52.52 ).transform( fromProjection, toProjection ); */
        var zoom           = 15; 
        openStreet.map.addLayer( mapnik );
        openStreet.map.setCenter( position, zoom );
      }
    </script>
  </head>
  <body onload="init();">
    <header>
		<input type="button" value="Food" onclick="" />
		<input type="button" value="Shopping" onclick="" />
		<input type="button" value="Gas Station" onclick="" />
		<input type="button" value="Car rental" onclick="" />
		<input type="button" value="Housing" onclick="" />
		<input type="button" value="Entertainment" onclick="" />
		<img id="search" src="leftarrow.png" width="35" height="50">
    </header>
    <div id="basicMap"></div>
    <script type="text/javascript">
		var useAddr = null;
	
		/**	track which user is using and display it.
		*/
		$(document).ready(function(){
			/*
			$('header').hide();
			$('#address').focus(function(){
				useAddr = true;
				$('#useIndicator').fadeOut(function(){
					$('#useIndicator').text("Using Position").fadeIn();
				});
			});
			$('.geoloc').focus(function(){
				useAddr = false;
				$('#useIndicator').fadeOut(function(){
					$('#useIndicator').text("Using Lon/Lat").fadeIn();
				});
			});
			*/
			
			$('#address').keypress(function(e) {
				if(e.which == 13) {
                                    useAddr = true;
                                    fireMe();
				}
			});
			$('.geoloc').keypress(function(e) {
				if(e.which == 13) {
                                    useAddr = false;
                                    fireMe();
				}
			});
			
			$('#search').on('click',function(){
				showSidebar();
			});
			
		});
	
		/**	Enter key or "map me" button click
		*/
		function fireMe() {
                        if(openStreet.map.markerLayer){
                            clearMap();
                        }
			var position = null;
			var addrVal = $('#address').val();
			var myLong = document.getElementById( 'longitude' ).value;
			var myLat = document.getElementById( 'latitide' ).value;
                        
			if( addrVal.trim() !== '' && useAddr ){//valid address
				goolgeLocate(addrVal);//let google find your location
			}else{
				//did u just enter lon/lat....? Are you human?
				position = lonLatSearch(myLong, myLat);
                                showLoation(position);
			}
		}
		
		function showSidebar(){
		
		}
		
		function hideSidebar(){
		
		}
		
		
		
                
                function showLocation(position){
                        var zoom           = 5; 
			
                        var size = new OpenLayers.Size(20,20);
                        var offset = new OpenLayers.Pixel(-(size.w/2), -size.h);
                        var icon = new OpenLayers.Icon('http://www.iconsdb.com/icons/download/black/x-mark-512.png', size, offset);
			var markerLayer = new OpenLayers.Layer.Markers( "Markers" );
                        openStreet.map.markerLayer = markerLayer;
			markerLayer.addMarker(new OpenLayers.Marker(position, icon.clone()));
			openStreet.map.addLayer(markerLayer);
			openStreet.map.setCenter( position, zoom );
                        //addPopup(myLong, myLat, "Long: " + myLong + " Lat: " + myLat, true);
                        
			//reset
			reset();
                }
                
                /**
                 * add a pop up
                 */
                function addPopup(lon, lat, html, canBeClose){
                    var popup = new OpenLayers.Popup.FramedCloud("Popup", new OpenLayers.LonLat(lon,lat), null, html, null, canBeClose);
                    openStreet.map.addPopup(popup);
                }
	
		/**	Let Google search your address and provide your geo-location
		*/
		function goolgeLocate(addr){
                    //Geocoder
                    var locator = new google.maps.Geocoder();
                    locator.geocode( { 'address': addr}, function( results, status){
                        if( status == google.maps.GeocoderStatus.OK ){
                            var lon = results[0].geometry.location.e;
                            var lat = results[0].geometry.location.d;
                            var position = lonLatSearch(lon, lat);
                            showLocation(position);
                        }
                    });
		}
		
		
		/**	You entered your own geo-location... Are you human?
		*/
		function lonLatSearch(myLong, myLat){  
			var fromProjection = new OpenLayers.Projection( "EPSG:4326" );   // Transform from WGS 1984
			var toProjection   = new OpenLayers.Projection( "EPSG:900913" ); // to Spherical Mercator Projection
			var position       = new OpenLayers.LonLat( myLong,myLat ).transform( fromProjection, toProjection );
			return position;
		}
		
		function reset(){
			useAddr = null;
		}
                
                function clearMap(){
                    //openStreet.map.markerLayer.clearMarkers();
                    var arr = openStreet.map.markerLayer.markers;
                    for(var i=0; i < arr.length; i++){
                        arr[i].destroy();
                    }
                }
    </script>
	<link rel="stylesheet" type="text/css" href="style.css">
  </body>
</html>
